name: Update PR Details

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      # Common trunk branch names - actual trunk branch is read from kira.yml and verified in workflow
      - master
      - main
      - develop

jobs:
  update-pr-details:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout PR head ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Read trunk branch from kira.yml
        id: trunk-branch
        run: |
          if [ ! -f kira.yml ]; then
            echo "Error: kira.yml not found"
            exit 1
          fi
          # Try to read trunk_branch using yq if available, otherwise use grep/sed
          if command -v yq &> /dev/null; then
            TRUNK=$(yq eval '.git.trunk_branch' kira.yml 2>/dev/null || echo "")
          else
            # Fallback: use grep and sed to extract trunk_branch value
            TRUNK=$(grep -E "^\s*trunk_branch\s*:" kira.yml | sed 's/.*trunk_branch\s*:\s*["'\'']*\([^"'\'']*\)["'\'']*/\1/' | tr -d ' ' || echo "")
          fi
          # If trunk_branch is empty or not set, default to master/main
          if [ -z "$TRUNK" ] || [ "$TRUNK" = "null" ]; then
            # Try to detect default branch
            if git show-ref --verify --quiet refs/heads/master; then
              TRUNK="master"
            else
              TRUNK="main"
            fi
          fi
          echo "trunk=$TRUNK" >> $GITHUB_OUTPUT
          echo "Trunk branch: $TRUNK"

      - name: Skip if head branch is trunk
        if: github.head_ref == steps.trunk-branch.outputs.trunk
        run: |
          echo "Skipping: PR head branch (${{ github.head_ref }}) is the trunk branch (${{ steps.trunk-branch.outputs.trunk }})"
          exit 0

      - name: Verify base branch matches trunk
        if: github.base_ref != steps.trunk-branch.outputs.trunk
        run: |
          echo "Error: PR base branch (${{ github.base_ref }}) does not match trunk branch (${{ steps.trunk-branch.outputs.trunk }})"
          exit 1

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build kira
        run: make build

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get PR title
        id: pr-title
        continue-on-error: true
        run: |
          TITLE=$(./bin/kira current --title 2>&1)
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Work item not found or invalid branch name, skipping PR update"
            echo "title=" >> $GITHUB_OUTPUT
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Get PR body
        id: pr-body
        if: steps.pr-title.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        run: |
          BODY=$(./bin/kira current --body 2>&1)
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Work item not found or invalid branch name, skipping PR update"
            echo "body=" >> $GITHUB_OUTPUT
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          # Check PR body size limit (~65KB)
          BODY_SIZE=$(echo "$BODY" | wc -c)
          MAX_SIZE=66560  # 65KB in bytes
          if [ $BODY_SIZE -gt $MAX_SIZE ]; then
            echo "Error: Work item file exceeds GitHub PR body size limit (~65KB). Please reduce the work item size or split it into multiple work items."
            exit 1
          fi
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Get related PRs
        id: prs
        if: steps.pr-title.outputs.skip != 'true' && steps.pr-body.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        run: |
          PRS=$(./bin/kira current prs 2>&1)
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ] || [ -z "$PRS" ] || [ "$PRS" = "[]" ]; then
            echo "No PRs found or error getting PR list, skipping PR update"
            echo "prs=[]" >> $GITHUB_OUTPUT
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          # Validate JSON structure
          if ! echo "$PRS" | jq empty 2>/dev/null; then
            echo "Error: Invalid JSON from kira current prs: $PRS"
            exit 1
          fi
          echo "prs<<EOF" >> $GITHUB_OUTPUT
          echo "$PRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Update PRs
        if: steps.pr-title.outputs.skip != 'true' && steps.pr-body.outputs.skip != 'true' && steps.prs.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRS='${{ steps.prs.outputs.prs }}'
          TITLE='${{ steps.pr-title.outputs.title }}'
          BODY='${{ steps.pr-body.outputs.body }}'
          
          # Parse PRs JSON array
          PR_COUNT=$(echo "$PRS" | jq '. | length')
          
          MAIN_REPO_UPDATED=false
          
          for i in $(seq 0 $((PR_COUNT - 1))); do
            OWNER=$(echo "$PRS" | jq -r ".[$i].owner")
            REPO=$(echo "$PRS" | jq -r ".[$i].repo")
            PR_NUMBER=$(echo "$PRS" | jq -r ".[$i].pr_number")
            BRANCH=$(echo "$PRS" | jq -r ".[$i].branch")
            
            # Check if this is the main repo (where workflow runs)
            IS_MAIN_REPO=false
            if [ "$OWNER/$REPO" = "${{ github.repository }}" ]; then
              IS_MAIN_REPO=true
            fi
            
            echo "Updating PR #$PR_NUMBER in $OWNER/$REPO..."
            
            # Update PR with retry logic for rate limiting
            MAX_RETRIES=3
            RETRY_DELAY=2
            RETRY_COUNT=0
            SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              RESPONSE=$(curl -s -w "\n%{http_code}" \
                -X PATCH \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Content-Type: application/json" \
                -d "{\"title\":$(echo "$TITLE" | jq -Rs .),\"body\":$(echo "$BODY" | jq -Rs .)}" \
                "https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUMBER")
              
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "Successfully updated PR #$PR_NUMBER in $OWNER/$REPO"
                SUCCESS=true
                if [ "$IS_MAIN_REPO" = "true" ]; then
                  MAIN_REPO_UPDATED=true
                fi
              elif [ "$HTTP_CODE" = "403" ]; then
                if [ "$IS_MAIN_REPO" = "true" ]; then
                  echo "Error: Failed to update PR in main repo ($OWNER/$REPO). Ensure the workflow has pull-requests: write permission. See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions for details."
                  exit 1
                else
                  echo "Warning: Could not update PR in $OWNER/$REPO: GITHUB_TOKEN does not have write access to this repository. To enable cross-repo PR updates, ensure the workflow runs with a token that has access to all repos, or configure repository permissions. Skipping this repo."
                  SUCCESS=true  # Mark as "success" to continue with other repos
                fi
              elif [ "$HTTP_CODE" = "404" ]; then
                if [ "$IS_MAIN_REPO" = "true" ]; then
                  echo "Error: PR #$PR_NUMBER not found in main repo ($OWNER/$REPO)"
                  exit 1
                else
                  echo "Info: No open PR found for branch $BRANCH in $OWNER/$REPO. This is expected if the PR hasn't been created yet or was closed. Skipping this repo."
                  SUCCESS=true  # Mark as "success" to continue with other repos
                fi
              elif [ "$HTTP_CODE" = "429" ]; then
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  DELAY=$((RETRY_DELAY * (2 ** RETRY_COUNT)))
                  echo "Rate limited (429). Retrying in $DELAY seconds... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                  sleep $DELAY
                else
                  if [ "$IS_MAIN_REPO" = "true" ]; then
                    echo "Error: Rate limited (429) after $MAX_RETRIES retries. Failed to update PR in main repo ($OWNER/$REPO)"
                    exit 1
                  else
                    echo "Warning: Rate limited (429) after $MAX_RETRIES retries. Skipping PR update in $OWNER/$REPO"
                    SUCCESS=true  # Mark as "success" to continue with other repos
                  fi
                fi
              else
                if [ "$IS_MAIN_REPO" = "true" ]; then
                  echo "Error: Failed to update PR in main repo ($OWNER/$REPO). HTTP $HTTP_CODE: $RESPONSE_BODY"
                  exit 1
                else
                  echo "Warning: Failed to update PR in $OWNER/$REPO. HTTP $HTTP_CODE: $RESPONSE_BODY. Skipping this repo."
                  SUCCESS=true  # Mark as "success" to continue with other repos
                fi
              fi
            done
          done
          
          if [ "$MAIN_REPO_UPDATED" = "false" ]; then
            echo "Warning: Main repo PR was not updated. This may indicate an issue with the workflow configuration."
          fi
